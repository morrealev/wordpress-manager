# CI/CD v2.0.0 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add CI/CD skill, agent, and detection script for WordPress pipeline automation (GitHub Actions, GitLab CI, Bitbucket Pipelines).

**Architecture:** Skill-only release (no new MCP tools). Detection script scans for existing CI config. Skill provides 7 reference files covering 3 platforms + wp-env CI + deploy strategies + secrets + quality gates. Agent orchestrates pipeline generation and troubleshooting via Bash, Read, Write.

**Tech Stack:** Node.js (.mjs detection script), Markdown (skill + references + agent), YAML (CI pipeline templates in references)

---

### Task 1: Create detection script `cicd_inspect.mjs`

**Files:**
- Create: `skills/wp-cicd/scripts/cicd_inspect.mjs`

**Step 1: Create directory structure**

```bash
mkdir -p skills/wp-cicd/scripts skills/wp-cicd/references
```

**Step 2: Write the detection script**

Pattern: follow `multisite_inspect.mjs` structure (readFileSafe, detectors, JSON report, exit codes).

Detectors:
1. **GitHub Actions**: scan `.github/workflows/*.yml` — extract job names, triggers, WP-specific steps
2. **GitLab CI**: scan `.gitlab-ci.yml` — extract stages, WP-specific jobs
3. **Bitbucket Pipelines**: scan `bitbucket-pipelines.yml` — extract pipeline steps
4. **Quality tools**: scan for `phpstan.neon*`, `phpcs.xml*`, `.phpcs.xml*`, `playwright.config.*`, `jest.config.*`, `phpunit.xml*`
5. **wp-env CI readiness**: check `.wp-env.json` or `.wp-env.override.json` presence

Output JSON:
```json
{
  "tool": "cicd_inspect",
  "version": "1.0.0",
  "timestamp": "...",
  "cwd": "...",
  "found": true,
  "platforms": {
    "github_actions": { "found": true, "workflows": [...], "has_wp_steps": true },
    "gitlab_ci": { "found": false },
    "bitbucket": { "found": false }
  },
  "quality_tools": {
    "phpstan": true,
    "phpcs": false,
    "playwright": true,
    "jest": true,
    "phpunit": true
  },
  "wp_env_ready": true,
  "recommendations": [...]
}
```

Exit codes: 0 = CI config found, 1 = no CI config found.

**Step 3: Test the script**

```bash
node skills/wp-cicd/scripts/cicd_inspect.mjs
```

Expected: exit 1 (no CI config in plugin dev dir), valid JSON output.

---

### Task 2: Create skill `wp-cicd/SKILL.md`

**Files:**
- Create: `skills/wp-cicd/SKILL.md`

**Step 1: Write the SKILL.md**

Structure (follow `wp-multisite/SKILL.md` pattern):

```yaml
---
name: wp-cicd
description: |
  This skill should be used when the user asks about "CI/CD", "pipeline",
  "GitHub Actions", "GitLab CI", "Bitbucket Pipelines", "deploy automation",
  "quality gates", "continuous integration", or WordPress CI/CD workflows.
version: 1.0.0
source: "vinmor/wordpress-manager"
---
```

Sections:
- **Overview**: CI/CD pipeline management for WordPress — multi-platform (GitHub Actions, GitLab CI, Bitbucket Pipelines)
- **When to Use**: CI setup, pipeline generation, quality gates, automated deploy, secrets management
- **Detection**: run `cicd_inspect.mjs`
- **CI/CD Decision Tree**:
  1. Which platform? → route to platform-specific reference
  2. What stage? → lint → test → build → deploy
  3. Quality gates? → PHPStan, PHPCS, coverage thresholds
  4. Deploy strategy? → blue-green, rolling, manual approval
- **Recommended Agent**: `wp-cicd-engineer`
- **Reference Files**: list all 7
- **Related Skills**: wp-e2e-testing (test stage), wp-deploy (deploy stage), wp-phpstan (quality gate)

---

### Task 3: Create 7 reference files

**Files:**
- Create: `skills/wp-cicd/references/github-actions-wordpress.md`
- Create: `skills/wp-cicd/references/gitlab-ci-wordpress.md`
- Create: `skills/wp-cicd/references/bitbucket-pipelines-wordpress.md`
- Create: `skills/wp-cicd/references/wp-env-ci.md`
- Create: `skills/wp-cicd/references/deploy-strategies.md`
- Create: `skills/wp-cicd/references/secrets-management.md`
- Create: `skills/wp-cicd/references/quality-gates.md`

**Step 1: Write all 7 reference files in parallel**

Each ~80-120 lines, actionable content with YAML/code examples.

#### github-actions-wordpress.md
- Complete workflow template for WP plugin/theme
- Matrix: PHP 7.4/8.0/8.2/8.3, WP latest/nightly
- Jobs: lint (PHPCS), static analysis (PHPStan), unit test (PHPUnit), E2E (Playwright + wp-env), deploy
- Caching: composer, npm, wp-env Docker images
- Artifact upload: test reports, screenshots

#### gitlab-ci-wordpress.md
- Multi-stage pipeline: `.pre` → lint → test → build → deploy
- Docker-in-Docker for wp-env
- Caching strategy
- Environment-based deploy (staging → production)

#### bitbucket-pipelines-wordpress.md
- Step-based pipeline with parallel steps
- Docker service for MySQL
- Deployment integration (SSH deploy pipe)
- Caching configuration

#### wp-env-ci.md
- Starting wp-env in CI (Docker-in-Docker or service)
- Port configuration and healthcheck
- Plugin/theme mounting in CI
- Parallel test execution
- Troubleshooting: Docker timeout, port conflicts

#### deploy-strategies.md
- Manual approval gate (GitHub environments)
- Blue-green: deploy to staging, verify, swap
- Rolling: deploy one server at a time
- Canary: percentage-based rollout
- WordPress-specific: maintenance mode during deploy, cache flush after

#### secrets-management.md
- GitHub Actions secrets / Dependabot secrets
- GitLab CI/CD variables (protected, masked)
- Bitbucket repository variables
- SSH key deployment (deploy keys)
- WordPress secrets: Application Password, WP_SITES_CONFIG, Hostinger API token
- .env handling: never commit, inject at runtime

#### quality-gates.md
- PHPStan: level config, baseline, fail on new errors
- PHPCS: WordPress coding standards
- Coverage thresholds: minimum %, fail if below
- Playwright: screenshot comparison, max failures
- Security scanning: composer audit, npm audit
- Merge/PR blocking: required status checks

---

### Task 4: Create agent `wp-cicd-engineer.md`

**Files:**
- Create: `agents/wp-cicd-engineer.md`

**Step 1: Write the agent file**

Follow `wp-test-engineer.md` pattern (frontmatter with examples, tools, procedures, safety rules).

```yaml
---
name: wp-cicd-engineer
color: cyan
description: |
  Use this agent when the user needs to set up, configure, or troubleshoot CI/CD pipelines for WordPress projects. Handles GitHub Actions, GitLab CI, Bitbucket Pipelines, quality gates, and automated deployment workflows.

  <example>
  Context: User wants to set up CI for their WordPress plugin.
  user: "Set up GitHub Actions for my WordPress plugin with PHPStan and Playwright"
  assistant: "I'll use the wp-cicd-engineer agent to create a CI pipeline."
  <commentary>CI setup requires detecting existing tools, generating workflow YAML, and configuring quality gates.</commentary>
  </example>

  <example>
  Context: User's CI pipeline is failing.
  user: "My GitHub Actions workflow fails on the Playwright step with Docker timeout"
  assistant: "I'll use the wp-cicd-engineer agent to diagnose the CI failure."
  <commentary>CI debugging requires understanding wp-env in Docker-in-Docker and CI-specific constraints.</commentary>
  </example>

  <example>
  Context: User wants to add automated deployment to their pipeline.
  user: "Add a deploy stage to my CI that deploys to Hostinger when I push to main"
  assistant: "I'll use the wp-cicd-engineer agent to configure the deployment stage."
  <commentary>Deploy automation requires secrets management, deployment strategy, and post-deploy verification.</commentary>
  </example>
model: inherit
tools: Read, Grep, Glob, Bash, Write, WebFetch, WebSearch
```

Note: this agent has **Write** tool (unlike most other agents) because it generates pipeline config files.

Procedures:
1. **Detect existing CI** — run `cicd_inspect.mjs`, identify platform and gaps
2. **Generate pipeline** — create workflow YAML based on detected tools and platform
3. **Configure quality gates** — PHPStan level, PHPCS ruleset, coverage threshold
4. **Configure secrets** — guide user through secret setup (never write actual secrets)
5. **Configure deploy stage** — deploy strategy, environment gates, post-deploy checks
6. **Troubleshoot** — diagnose CI failures, Docker issues, timeout, permission errors

Safety Rules:
- NEVER write actual secrets or credentials to files
- NEVER push CI config without user review
- ALWAYS validate YAML syntax before suggesting commit
- ALWAYS use `--dry-run` for search-replace operations in CI
- NEVER deploy to production without explicit user approval
- ALWAYS recommend staging deploy first

---

### Task 5: Update router decision-tree.md

**Files:**
- Modify: `skills/wordpress-router/references/decision-tree.md`

**Step 1: Update header to v7**

**Step 2: Add CI/CD keywords to Step 0**

In "Keywords that indicate **development**" line, append:
`CI, CD, pipeline, GitHub Actions, GitLab CI, deploy automatico, workflow, quality gate`

**Step 3: Add CI/CD route to Step 2a**

After the existing headless entry, add:
```
- **CI / CD / pipeline / GitHub Actions / GitLab CI / Bitbucket Pipelines / quality gate / deploy automatico**
  → `wp-cicd` skill + `wp-cicd-engineer` agent
```

---

### Task 6: Add cross-references to 3 existing skills

**Files:**
- Modify: `skills/wp-e2e-testing/SKILL.md` (append)
- Modify: `skills/wp-deploy/SKILL.md` (append)
- Modify: `skills/wp-phpstan/SKILL.md` (append)

**Step 1: wp-e2e-testing — add CI cross-ref**

At the end of the file, after "Recommended Agent" section, add:
```markdown

### CI/CD Integration

For integrating WordPress tests into CI/CD pipelines (GitHub Actions, GitLab CI, Bitbucket Pipelines), see the `wp-cicd` skill and `wp-cicd-engineer` agent.
```

**Step 2: wp-deploy — add CI cross-ref**

At the end of the file, add:
```markdown

### Automated Deployment

For automated deployments via CI/CD pipelines, see the `wp-cicd` skill and `wp-cicd-engineer` agent.
```

**Step 3: wp-phpstan — add CI cross-ref**

At the end of the file, add:
```markdown

### CI/CD Quality Gates

For integrating PHPStan as a quality gate in CI/CD pipelines, see the `wp-cicd` skill (`references/quality-gates.md`).
```

---

### Task 7: Update wp-site-manager delegation table

**Files:**
- Modify: `agents/wp-site-manager.md`

**Step 1: Add CI/CD row to delegation table**

After the "Multisite network management" row, add:
```
| CI/CD pipeline setup and troubleshooting | `wp-cicd-engineer` | GitHub Actions, GitLab CI, Bitbucket, quality gates |
```

---

### Task 8: Version bump + CHANGELOG

**Files:**
- Modify: `.claude-plugin/plugin.json` (1.9.0 → 2.0.0)
- Modify: `package.json` (1.9.0 → 2.0.0)
- Modify: `CHANGELOG.md` (add v2.0.0 entry)

**Step 1: Update plugin.json**

- Version: `1.9.0` → `2.0.0`
- Description: update to mention 10 agents, 27 skills, CI/CD
- Keywords: add `ci-cd`, `github-actions`

**Step 2: Update package.json**

- Version: `1.9.0` → `2.0.0`
- Description: update to mention CI/CD, 10 agents, 27 skills
- Keywords: add `ci-cd`, `github-actions`, `gitlab-ci`

**Step 3: Add CHANGELOG entry**

```markdown
## [2.0.0] - 2026-02-28

### Added
- **CI/CD support** — new skill and agent for WordPress pipeline automation
- **New skill**: `wp-cicd` with 7 reference files (GitHub Actions, GitLab CI, Bitbucket, wp-env CI, deploy strategies, secrets, quality gates)
- **New agent**: `wp-cicd-engineer` (color: cyan) — pipeline generation, quality gates, deploy automation, CI troubleshooting
- **Detection script**: `cicd_inspect.mjs` — detects CI platforms, quality tools, wp-env readiness

### Changed
- Router decision-tree.md upgraded to v7 with CI/CD keywords and routing
- `wp-e2e-testing`, `wp-deploy`, `wp-phpstan` skills: added CI/CD cross-references
- `wp-site-manager` agent: added CI/CD delegation row
- Plugin now has 10 agents and 27 skills
```

---

## Implementation Order

```
Phase 1 — Core (sequential):
  Task 1: cicd_inspect.mjs (detection script)
  Task 2: wp-cicd/SKILL.md (skill)
  Task 3: 7 reference files (parallelizable)

Phase 2 — Agent:
  Task 4: wp-cicd-engineer.md

Phase 3 — Integration (parallelizable):
  Task 5: Router update (decision-tree.md v7)
  Task 6: Cross-references (3 skills)
  Task 7: wp-site-manager delegation

Phase 4 — Release:
  Task 8: Version bump + CHANGELOG
```

## Verification

- `cicd_inspect.mjs` runs without errors (exit 1 in plugin dev dir)
- All new files have valid structure
- Router v7 routes CI/CD keywords correctly
- Cross-references are bidirectional: skill → agent, agent → skill
- Delegation table in wp-site-manager has CI/CD row
- Version 2.0.0 across plugin.json, package.json, CHANGELOG
